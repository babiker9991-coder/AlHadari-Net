<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø­Ø¶Ø±ÙŠ Ù†Øª Ø±ÙŠØ§Ø¶Ø© - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„</title>
<style>
  body{font-family:Tahoma,Arial; background:#f4f6fb; margin:0; padding:0}
  header{background:#003366;color:#fff;padding:18px;text-align:center;font-size:20px}
  .wrap{max-width:980px;margin:20px auto;padding:18px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
  input,textarea,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc}
  button{background:#003366;color:#fff;border:none;cursor:pointer}
  #status{margin-top:8px;font-weight:bold}
  .error{color:#c62828}
  .success{color:#2e7d32}
  .news-item{border-bottom:1px solid #eee;padding:12px 0}
  img.news-img{max-width:100%;border-radius:6px;margin-top:8px}
  pre{background:#f0f0f0;padding:8px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
<header>Ø§Ù„Ø­Ø¶Ø±ÙŠ Ù†Øª Ø±ÙŠØ§Ø¶Ø© â€” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„</header>
<div class="wrap">
  <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù (Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„ØªØ¸Ù‡Ø±)</h3>
  <p>Ù…Ù„Ø§Ø­Ø¸Ø©: ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø´Ø±Ù: <code>221133</code></p>
  <div id="adminArea" style="display:none">
    <input id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
    <textarea id="content" rows="4" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø¨Ø±"></textarea>
    <input type="file" id="image">
    <button id="btnPublish" onclick="addNews()">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± (Ø±ÙØ¹ ØµÙˆØ±Ø© & Ø­ÙØ¸ ÙÙŠ DB)</button>
    <p id="status"></p>
    <hr>
    <button onclick="testStorage()">Ø§Ø®ØªØ¨Ø§Ø± Ø±ÙØ¹ Ù…Ù„Ù ØµØºÙŠØ± (Test Upload)</button>
    <button onclick="testDbWrite()">Ø§Ø®ØªØ¨Ø§Ø± ÙƒØªØ§Ø¨Ø© DB</button>
    <pre id="debug"></pre>
  </div>

  <h3>Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h3>
  <div id="newsList">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</div>
  <hr>
  <h4>ØªÙˆØ¬ÙŠÙ‡Ø§Øª ØªØµØ­ÙŠØ­ÙŠØ© Ø³Ø±ÙŠØ¹Ø©</h4>
  <ol>
    <li>ØªØ£ÙƒØ¯ Ø£Ù† Ù†Ø³Ø®ØªÙƒ Ù…Ù† <strong>firebaseConfig</strong> ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„: <code>apiKey, authDomain, databaseURL, projectId, storageBucket, appId</code>.</li>
    <li>Ø§Ø³ØªØ®Ø¯Ù… <code>storageBucket</code> Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„: <code>your-project-id.appspot.com</code> (Ù„ÙŠØ³ .firebasestorage.app).</li>
    <li>Ø§ÙØªØ­ Console (F12 â†’ Console) ÙˆØ§Ù†Ø³Ø® Ø£ÙŠ Ø®Ø·Ø£ Ù‡Ù†Ø§ ÙˆØ³Ø£ÙÙ‡Ù…Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.</li>
    <li>Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø¶Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Realtime DB Ùˆ Storage Ù…Ø¤Ù‚ØªØ§Ù‹ ÙƒÙ€ test (Ø£Ù†ØµØ­ Ø£Ù† ØªÙØ¹Ù„ Ø°Ù„Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·).</li>
  </ol>
</div>

<!-- Firebase compat (Realtime DB + Storage) -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>

<script>
/* =======================
   --- Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù‡Ù†Ø§ ---
   Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù…Ù† Firebase Console â†’ Project settings â†’ SDK setup
   Ù…Ø«Ø§Ù„:
   databaseURL: "https://your-app-default-rtdb.firebaseio.com",
   storageBucket: "your-app.appspot.com",
   --------------------------------*/
const firebaseConfig = {
  apiKey: "Ø¶Ø¹-apiKey-here",
  authDomain: "Ø¶Ø¹-authDomain-here",
  databaseURL: "Ø¶Ø¹-databaseURL-here",
  projectId: "Ø¶Ø¹-projectId-here",
  storageBucket: "Ø¶Ø¹-storageBucket-here", // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ...appspot.com
  messagingSenderId: "Ø¶Ø¹-messagingSenderId-here",
  appId: "Ø¶Ø¹-appId-here"
};
/* ======================= */

const debugEl = document.getElementById('debug');
function dbg(...args){ console.log(...args); debugEl.textContent += args.map(a=> (typeof a==='object'? JSON.stringify(a,null,2): String(a)) ).join(' ') + '\n'; }

try {
  firebase.initializeApp(firebaseConfig);
} catch(err){
  console.error("Firebase init error:", err);
  dbg("Firebase init error:", err);
  document.getElementById('newsList').innerHTML = '<p class="error">Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase â€” Ø§ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.</p>';
}

const db = firebase.database();
const storage = firebase.storage();

// basic global
let isAdmin = false;
const ADMIN_PASS = "221133";

// show admin after prompt (runs on load)
window.addEventListener('load', () => {
  try {
    const p = prompt("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´Ø±Ù Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø£Ùˆ Ø§Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·):");
    if(p === ADMIN_PASS){
      isAdmin = true;
      document.getElementById('adminArea').style.display = 'block';
    }
    loadNews(); // always try to load news
    attachGlobalErrorHandler();
  } catch(e) {
    dbg("onload err", e);
  }
});

// attach window.onerror to capture runtime exceptions
function attachGlobalErrorHandler(){
  window.onerror = function(message, source, lineno, colno, error) {
    dbg("Global Error:", message, "at", source + ":" + lineno + ":" + colno, error);
    return false;
  };
}

// upload image to storage and return downloadURL
async function uploadImageFile(file){
  if(!file) return "";
  const path = 'news_images/' + Date.now() + '_' + file.name;
  const ref = storage.ref().child(path);
  dbg("Starting upload to", path);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  dbg("Upload finished, URL:", url);
  return url;
}

// add news (upload image then push to Realtime DB)
async function addNews(){
  const status = document.getElementById('status');
  status.className = '';
  status.textContent = '';
  try{
    if(!isAdmin){ status.textContent = "âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø±Ù ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ù†Ø´Ø±."; status.className = 'error'; return; }
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const fileEl = document.getElementById('image');
    if(!title || !content){ status.textContent = "â— ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰."; status.className='error'; return; }
    status.textContent = 'â³ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø¥Ù† ÙˆÙØ¬Ø¯Øª) Ø«Ù… Ø­ÙØ¸ Ø§Ù„Ø®Ø¨Ø±...';
    // upload
    let imageUrl = "";
    if(fileEl.files && fileEl.files[0]) {
      imageUrl = await uploadImageFile(fileEl.files[0]);
    }
    // write to Realtime DB
    const newsRef = db.ref('news').push();
    await newsRef.set({
      title, content, imageUrl, likes:0, createdAt: Date.now()
    });
    status.textContent = 'âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­.';
    status.className = 'success';
    // clear fields
    document.getElementById('title').value = '';
    document.getElementById('content').value = '';
    fileEl.value = '';
    // reload list
    loadNews();
  } catch(err){
    console.error("addNews error:", err);
    dbg("addNews error:", err);
    status.textContent = 'âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±: ' + (err.message || err);
    status.className = 'error';
  }
}

// load news list from Realtime DB
function loadNews(){
  const list = document.getElementById('newsList');
  list.innerHTML = 'â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...';
  db.ref('news').orderByChild('createdAt').on('value', snapshot => {
    list.innerHTML = '';
    const data = snapshot.val();
    if(!data){ list.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ø¨Ø¹Ø¯.</p>'; return; }
    // snapshot is ordered asc, we'll show newest first
    const entries = Object.keys(data).map(k => ({id:k, v:data[k]})).sort((a,b)=> b.v.createdAt - a.v.createdAt);
    entries.forEach(entry => {
      const d = entry.v;
      const div = document.createElement('div');
      div.className = 'news-item';
      div.innerHTML = `<h3>${escapeHtml(d.title)}</h3>
                       <p>${escapeHtml(d.content)}</p>
                       ${d.imageUrl? `<img class="news-img" src="${d.imageUrl}" alt="ØµÙˆØ±Ø©">` : ''}
                       <div style="margin-top:8px;color:#666;font-size:13px">Ù†ÙØ´Ø±: ${new Date(d.createdAt).toLocaleString()}</div>
                       <div id="actions-${entry.id}"></div>
                       <div id="comments-${entry.id}"></div>`;
      list.appendChild(div);
      renderActions(entry.id, d);
      renderComments(entry.id);
    });
  }, err => {
    console.error("loadNews on error:", err);
    dbg("loadNews on error:", err);
    list.innerHTML = '<p class="error">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± - Ø§ÙØªØ­ Console Ù„Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>';
  });
}

// render like button and comment input
function renderActions(newsId, data){
  const container = document.getElementById('actions-' + newsId);
  container.innerHTML = '';
  const likeBtn = document.createElement('button');
  likeBtn.textContent = `â¤ï¸ ${data.likes || 0}`;
  likeBtn.onclick = () => {
    const likesRef = db.ref('news/' + newsId + '/likes');
    likesRef.transaction(l => (l||0) + 1);
  };
  const toggleBtn = document.createElement('button');
  toggleBtn.style.marginLeft = '8px';
  toggleBtn.textContent = 'ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚';
  toggleBtn.onclick = () => {
    const comm = document.getElementById('comments-' + newsId);
    if(comm.style.display === 'block') { comm.style.display = 'none'; } else { comm.style.display = 'block'; }
  };
  container.appendChild(likeBtn);
  container.appendChild(toggleBtn);
}

// render comments section and listen for updates
function renderComments(newsId){
  const cDiv = document.getElementById('comments-' + newsId);
  cDiv.innerHTML = '';
  cDiv.style.display = 'none';
  // input and button
  const input = document.createElement('input');
  input.placeholder = 'Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„';
  input.style.marginTop = '8px';
  const send = document.createElement('button');
  send.textContent = 'Ø¥Ø±Ø³Ø§Ù„';
  send.onclick = () => {
    const text = input.value.trim();
    if(!text) return alert('Ø£Ø¯Ø®Ù„ ØªØ¹Ù„ÙŠÙ‚');
    // for now use "Ø²Ø§Ø¦Ø±" as user (or use authenticated email if you add auth)
    const user = 'Ø²Ø§Ø¦Ø±';
    db.ref('news/' + newsId + '/comments').push({user, text, createdAt: Date.now()});
    input.value = '';
  };
  cDiv.appendChild(input);
  cDiv.appendChild(send);
  // comments list
  const list = document.createElement('div');
  list.style.marginTop = '8px';
  cDiv.appendChild(list);

  db.ref('news/' + newsId + '/comments').on('value', snap => {
    list.innerHTML = '';
    const val = snap.val();
    if(!val) { list.innerHTML = '<div style="color:#666">Ù„Ø§ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯</div>'; return; }
    const items = Object.keys(val).map(k=> ({id:k, v:val[k]})).sort((a,b)=> a.v.createdAt - b.v.createdAt);
    items.forEach(it => {
      const cd = document.createElement('div');
      cd.style.padding='6px';
      cd.style.borderBottom='1px solid #eee';
      cd.innerHTML = `<strong>${escapeHtml(it.v.user)}</strong>: ${escapeHtml(it.v.text)}<div style="font-size:11px;color:#666">${new Date(it.v.createdAt).toLocaleString()}</div>`;
      list.appendChild(cd);
    });
  });
}

// small helpers
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ========== Test utilities for debugging ========== */
async function testStorage(){
  const msg = document.getElementById('status');
  try{
    const blob = new Blob(['test'], {type:'text/plain'});
    const ref = storage.ref().child('test/test_' + Date.now() + '.txt');
    await ref.put(blob);
    const url = await ref.getDownloadURL();
    msg.textContent = 'âœ… Ø±ÙØ¹ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø§Ø¬Ø­. URL: ' + url;
    msg.className = 'success';
    dbg('testStorage URL:', url);
  } catch(e){
    dbg('testStorage error:', e);
    msg.textContent = 'âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + e.message;
    msg.className = 'error';
  }
}

async function testDbWrite(){
  const msg = document.getElementById('status');
  try{
    await db.ref('debug/test').set({ts: Date.now(), msg: 'hello'});
    msg.textContent = 'âœ… ÙƒØªØ§Ø¨Ø© DB Ù†Ø§Ø¬Ø­Ø©';
    msg.className = 'success';
    dbg('testDbWrite ok');
  } catch(e){
    dbg('testDbWrite error', e);
    msg.textContent = 'âŒ ÙØ´Ù„ ÙƒØªØ§Ø¨Ø© DB: ' + e.message;
    msg.className = 'error';
  }
}
</script>
</body>
</html>
